name: Stripe Full Sync

on:
  schedule:
    - cron: "0 6 * * *" # every day at 06:00 UTC
  workflow_dispatch:
  workflow_call:

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Trigger full sync (with retry)
        env:
          API_URL: ${{ vars.PRODUCTION_API_URL }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          set -euo pipefail
          
          # Configuration
          MAX_RETRIES=3
          RETRY_DELAY=5
          TIMEOUT=30
          ATTEMPT=1
          
          echo "üîÑ Stripe Sync Configuration:"
          echo "  Max Retries: $MAX_RETRIES"
          echo "  Retry Delay: ${RETRY_DELAY}s"
          echo "  Timeout: ${TIMEOUT}s"
          echo ""
          
          # Validate configuration
          if [ -z "$API_URL" ]; then
            echo "‚ùå PRODUCTION_API_URL not configured. Failing sync."
            echo "To enable this workflow, set the PRODUCTION_API_URL repository variable."
            exit 1
          fi
          
          echo "‚úÖ API URL configured: $API_URL"
          echo ""
          
          # Retry loop
          while [ $ATTEMPT -le $MAX_RETRIES ]; do
            echo "üì§ Attempt $ATTEMPT/$MAX_RETRIES: Triggering Stripe full sync..."
            
            # Prepare headers
            HEADERS="-H 'Content-Type: application/json'"
            if [ -n "$API_TOKEN" ]; then
              HEADERS="$HEADERS -H 'Authorization: Bearer $API_TOKEN'"
            fi
            
            # Make the API call with timeout and error handling
            HTTP_STATUS=$(curl -s -w "%{http_code}" \
              --max-time $TIMEOUT \
              --connect-timeout 10 \
              --retry 2 \
              --retry-delay 2 \
              -X POST "$API_URL/stripe/sync" \
              $HEADERS \
              -d '{"action":"all"}' \
              -o response.json) || HTTP_STATUS=$?
            
            echo "HTTP Status: $HTTP_STATUS"
            
            # Check if the request was successful
            if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
              echo "‚úÖ API call successful"
              
              # Validate JSON response
              if command -v jq >/dev/null 2>&1; then
                if jq -e '.success == true' response.json >/dev/null 2>&1; then
                  echo "‚úÖ Stripe sync completed successfully"
                  cat response.json
                  exit 0
                else
                  ERROR_MSG=$(jq -r '.error // .message // "Unknown error"' response.json)
                  echo "‚ùå Stripe sync failed - API returned success: false"
                  echo "Error: $ERROR_MSG"
                  cat response.json
                  
                  # Don't retry on application errors
                  exit 1
                fi
              else
                echo "‚ö†Ô∏è  jq not available, accepting response as valid"
                cat response.json
                exit 0
              fi
            else
              echo "‚ùå API call failed with HTTP status: $HTTP_STATUS"
              
              # Check if response file exists and is readable
              if [ -f response.json ] && [ -s response.json ]; then
                echo "Response:"
                cat response.json
              else
                echo "No response body received"
              fi
              
              # Retry logic for transient errors (5xx errors)
              if [[ "$HTTP_STATUS" =~ ^5 ]]; then
                if [ $ATTEMPT -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Transient error detected. Retrying in ${RETRY_DELAY}s..."
                  sleep $RETRY_DELAY
                  ATTEMPT=$((ATTEMPT + 1))
                  continue
                else
                  echo "‚ùå Max retries reached. Failing."
                  exit 1
                fi
              else
                # Don't retry on client errors (4xx)
                echo "‚ùå Client error detected (HTTP $HTTP_STATUS). Not retrying."
                exit 1
              fi
            fi
          done
          
          echo "‚ùå All retry attempts failed"
          exit 1

      - name: Notify on failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST "$SLACK_WEBHOOK" \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "‚ùå Stripe Sync Failed",
                "blocks": [{
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Stripe Full Sync Failed*\nRun: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }]
              }'
          fi
