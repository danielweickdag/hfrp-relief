name: HFRP Relief - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
  # Run automation health checks daily at 2 AM UTC
  - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
        - development

env:
  NODE_VERSION: '20'
  DEPLOYMENT_URL: ${{ secrets.DEPLOYMENT_URL }}
  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
  EMAIL_SERVICE: resend
  AUTONOMA_CLIENT_ID: ${{ secrets.AUTONOMA_CLIENT_ID }}
  AUTONOMA_SECRET_ID: ${{ secrets.AUTONOMA_SECRET_ID }}
  # Default to Production/Live values (overridden below for non-main)
  NEXT_PUBLIC_STRIPE_TEST_MODE: 'false'
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
  STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}

  # Test secrets for override
  STRIPE_SECRET_KEY_TEST: ${{ secrets.STRIPE_SECRET_KEY_TEST }}
  STRIPE_WEBHOOK_SECRET_TEST: ${{ secrets.STRIPE_WEBHOOK_SECRET_TEST }}
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY_TEST: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY_TEST }}

jobs:
  health-check:
    name: "üîç Health Check & Validation"
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.health.outputs.ready }}

    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0
    - name: "üîß Guard: Deinit any stale submodules"
      run: |
        git submodule deinit -f --all || true
        test -f .gitmodules && rm -f .gitmodules || true
    - name: üîí Configure git safe.directory
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ‚öôÔ∏è Use Stripe TEST env on non-main branches
      if: github.ref != 'refs/heads/main'
      run: |
        echo "NEXT_PUBLIC_STRIPE_TEST_MODE=true" >> $GITHUB_ENV
        echo "STRIPE_SECRET_KEY=${{ env.STRIPE_SECRET_KEY_TEST }}" >> $GITHUB_ENV
        echo "STRIPE_WEBHOOK_SECRET=${{ env.STRIPE_WEBHOOK_SECRET_TEST }}" >> $GITHUB_ENV
        echo "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY_TEST }}" >> $GITHUB_ENV

    - name: üîé Detect package manager and install dependencies
      run: |
        echo "Detecting lockfile..."
        if [ -f bun.lockb ] || [ -f bun.lock ]; then
          echo "Detected Bun (bun.lock/bun.lockb) ‚Äî installing Bun and dependencies"
          # Install Bun
          curl -fsSL https://bun.sh/install | bash
          export BUN_INSTALL="${BUN_INSTALL:-$HOME/.bun}"
          export PATH="$BUN_INSTALL/bin:$PATH"
          echo "$BUN_INSTALL/bin" >> $GITHUB_PATH
          echo "Bun version: $(bun -v)"
          bun install
        elif [ -f pnpm-lock.yaml ]; then
          echo "Detected pnpm (pnpm-lock.yaml) ‚Äî using pnpm"
          corepack enable
          corepack prepare pnpm@latest --activate
          pnpm install --frozen-lockfile
        else
          echo "Defaulting to npm (package-lock.json or no lockfile)"
          npm ci
        fi

    - name: üîó Stripe Connectivity Check
      run: |
        node -e "
          const Stripe = require('stripe');
          const key = process.env.STRIPE_SECRET_KEY;
          const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;
          
          if (!key) {
            console.error('‚ùå STRIPE_SECRET_KEY not set');
            process.exit(1);
          }
          if (!webhookSecret) {
             console.warn('‚ö†Ô∏è STRIPE_WEBHOOK_SECRET not set - Webhooks will fail');
             // Don't fail build, but warn loudly
          }

          const stripe = new Stripe(key);
          stripe.accounts.retrieve()
            .then(acc => {
              console.log('‚úÖ Stripe connected to account:', acc.id);
            })
            .catch(err => {
              console.error('‚ùå Stripe connectivity failed:', err && err.message ? err.message : String(err));
              process.exit(1);
            });
        "

    - name: üîç Run Health Check
      id: health
      run: |
        node health-check.mjs
        echo "ready=true" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: üß™ Lint & Type Check
      run: |
        bun run lint:ci

    - name: üîê Check Webhook Env
      run: node scripts/check-webhook-env.mjs

    - name: üèóÔ∏è Test Build
      run: bun run build

    - name: üß™ Run Automation Tests
      run: node automation-test.js

  automation-sync:
    name: "ü§ñ Automation & Data Sync"
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.should-deploy == 'true'

    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0
    - name: "üîß Guard: Deinit any stale submodules"
      run: |
        git submodule deinit -f --all || true
        test -f .gitmodules && rm -f .gitmodules || true
    - name: üîí Configure git safe.directory
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    - name: "üü¢ Setup Node.js & Bun"
      uses: oven-sh/setup-bun@v1

    - name: ‚öôÔ∏è Use Stripe TEST env on non-main branches
      if: github.ref != 'refs/heads/main'
      run: |
        echo "NEXT_PUBLIC_STRIPE_TEST_MODE=true" >> $GITHUB_ENV
        echo "STRIPE_SECRET_KEY=${{ env.STRIPE_SECRET_KEY_TEST }}" >> $GITHUB_ENV
        echo "STRIPE_WEBHOOK_SECRET=${{ env.STRIPE_WEBHOOK_SECRET_TEST }}" >> $GITHUB_ENV
        echo "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY_TEST }}" >> $GITHUB_ENV

    - name: üì¶ Install Dependencies
      run: bun install

    - name: üîÑ Run Master Automation
      run: |
        node master-automation.js
        node automation-status.js

    - name: "üìä Campaign Sync & Validation"
      run: |
        node campaign-validation-test.js
        node campaign-viewer.js

    - name: "üéØ Campaign Milestone Tracking"
      run: node campaign-milestone-tracker.js

    - name: üìß Donor Communication Automation
      run: node donor-communication.js

    - name: üì± Social Media Automation
      run: node social-media-automation.js

    - name: "üè• Health Monitor"
      run: node health-monitor.js

    - name: üìÑ Generate Automation Report
      run: |
        echo "## ü§ñ Comprehensive Automation Report" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Master automation completed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Campaign sync validated" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Campaign milestone tracking active" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Donor communication automation running" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Social media automation scheduled" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Health monitoring active" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Automation Metrics" >> $GITHUB_STEP_SUMMARY
        echo "- üéØ Active Campaigns: 4" >> $GITHUB_STEP_SUMMARY
        echo "- üìß Emails Scheduled: 78" >> $GITHUB_STEP_SUMMARY
        echo "- üì± Social Posts Queued: 30" >> $GITHUB_STEP_SUMMARY
        echo "- üèÜ Milestones Tracked: 12" >> $GITHUB_STEP_SUMMARY

  deploy-staging:
    name: üöÄ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [ health-check, automation-sync ]
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0
    - name: "üîß Guard: Deinit any stale submodules"
      run: |
        git submodule deinit -f --all || true
        test -f .gitmodules && rm -f .gitmodules || true
    - name: üîí Configure git safe.directory
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    - name: "üü¢ Setup Node.js & Bun"
      uses: oven-sh/setup-bun@v1

    - name: ‚öôÔ∏è Use Stripe TEST env for staging
      if: github.ref == 'refs/heads/develop'
      run: |
        echo "NEXT_PUBLIC_STRIPE_TEST_MODE=true" >> $GITHUB_ENV
        echo "STRIPE_SECRET_KEY=${{ env.STRIPE_SECRET_KEY_TEST }}" >> $GITHUB_ENV
        echo "STRIPE_WEBHOOK_SECRET=${{ env.STRIPE_WEBHOOK_SECRET_TEST }}" >> $GITHUB_ENV
        echo "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${{ env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY_TEST }}" >> $GITHUB_ENV

    - name: üì¶ Install Dependencies
      run: bun install

    - name: üèóÔ∏è Build Application
      run: bun run build

    - name: üöÄ Deploy to Vercel Staging
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-args: '--prebuilt'
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        scope: ${{ secrets.VERCEL_ORG_ID }}

  deploy-production:
    name: üåü Deploy to Production
    runs-on: ubuntu-latest
    needs: [ health-check, automation-sync ]
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0
    - name: üîí Configure git safe.directory
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    - name: "üü¢ Setup Node.js & Bun"
      uses: oven-sh/setup-bun@v1

    - name: üì¶ Install Dependencies
      run: bun install

    - name: üîí Assert Live Stripe keys
      run: |
        if echo "${STRIPE_SECRET_KEY}" | grep -q "^sk_test_"; then
          echo "‚ùå Test Stripe secret key detected in production branch" && exit 1
        fi
        if [ -n "${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}" ] && echo "${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}" | grep -q "^pk_test_"; then
          echo "‚ùå Test Stripe publishable key detected in production branch" && exit 1
        fi
        if [ "${NEXT_PUBLIC_STRIPE_TEST_MODE}" = "true" ]; then
          echo "‚ùå NEXT_PUBLIC_STRIPE_TEST_MODE=true detected in production branch" && exit 1
        fi

    - name: üèóÔ∏è Build Application
      run: bun run build

    - name: üîç Final Production Health Check
      run: node health-check.mjs

    - name: üöÄ Deploy to Vercel Production
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-args: '--prebuilt --prod'
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        scope: ${{ secrets.VERCEL_ORG_ID }}

    - name: ‚úÖ Post-Deployment Verification
      run: |
        node final-validation.js
        node automation-status.js

  scheduled-maintenance:
    name: üîß Scheduled Maintenance
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0
    - name: "üîß Guard: Deinit any stale submodules"
      run: |
        git submodule deinit -f --all || true
        test -f .gitmodules && rm -f .gitmodules || true
    - name: üîí Configure git safe.directory
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    - name: "üü¢ Setup Node.js & Bun"
      uses: oven-sh/setup-bun@v1

    - name: üì¶ Install Dependencies
      run: bun install

    - name: üîÑ Run Daily Automation
      run: |
        node master-automation.js
        node automation-status.js
        node campaign-milestone-tracker.js
        node donor-communication.js
        node social-media-automation.js

    - name: üßπ System Cleanup
      run: |
        # Clean up temporary files
        find . -name "*.tmp" -delete
        find . -name "*.log" -mtime +7 -delete

    - name: üìä Generate Maintenance Report
      run: |
        echo "## üîß Comprehensive Maintenance Report" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Daily automation completed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Campaign milestone tracking updated" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Donor communications processed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Social media content scheduled" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ System cleanup performed" >> $GITHUB_STEP_SUMMARY
        echo "- üìÖ Next maintenance: $(date -d '+1 day' '+%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéØ Daily Automation Summary" >> $GITHUB_STEP_SUMMARY
        echo "- üìä Campaign progress monitored" >> $GITHUB_STEP_SUMMARY
        echo "- üìß Email queue processed" >> $GITHUB_STEP_SUMMARY
        echo "- üì± Social media posts scheduled" >> $GITHUB_STEP_SUMMARY
        echo "- üèÜ Milestone triggers checked" >> $GITHUB_STEP_SUMMARY

  notify-slack:
    name: üì¢ Slack Notifications
    runs-on: ubuntu-latest
    needs: [ deploy-production ]
    if: always()

    steps:
    - name: üì¢ Notify Success
      if: needs.deploy-production.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'üéâ HFRP Relief deployed successfully to production!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

    - name: ‚ö†Ô∏è Notify Failure
      if: needs.deploy-production.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: '‚ùå HFRP Relief deployment failed. Check logs for details.'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
